<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Đối Soát Dữ Liệu (Matching/Not Matching)</title>
    <script
      id="xlsx-lib"
      src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
    ></script>
    <script
      id="chartjs-lib"
      src="https://cdn.jsdelivr.net/npm/chart.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-color: #4a90e2;
        --secondary-color: #50e3c2;
        --success-color: #28a745;
        --danger-color: #d0021b;
        --warning-color: #f5a623;
        --background-color: #f4f7fc;
        --card-background: #ffffff;
        --text-color: #4a4a4a;
        --heading-color: #1c3d5a;
        --border-color: #eaeaea;
        --shadow-color: rgba(60, 64, 67, 0.15);
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        margin: 0;
        padding: 20px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transition: margin-left 0.3s;
      }
      /* CSS CHO FILE EXPORT */
      #export-sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 260px;
        height: 100vh;
        background: var(--card-background);
        border-right: 1px solid var(--border-color);
        box-shadow: 4px 0 10px rgba(0, 0, 0, 0.05);
        overflow-y: auto;
        z-index: 1010;
        padding: 20px;
        box-sizing: border-box;
      }
      #export-sidebar h3 {
        margin-top: 0;
        color: var(--heading-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
        font-size: 1.2em;
      }
      #export-catalog-list {
        list-style: none;
        padding: 0;
        margin: 20px 0 0 0;
      }
      #export-catalog-list li a {
        text-decoration: none;
        color: var(--primary-color);
        font-size: 0.9em;
        padding: 8px 10px;
        display: block;
        border-radius: 5px;
        margin-bottom: 5px;
        transition: all 0.2s;
      }
      #export-catalog-list li a:hover {
        background-color: var(--background-color);
        color: var(--heading-color);
      }
      #export-catalog-list li a.section-title {
        font-weight: 700;
        color: var(--heading-color);
        font-size: 1em;
        padding-left: 0;
        margin-top: 15px;
      }
      #export-catalog-list li a.chart-title {
        padding-left: 20px;
        font-weight: 500;
      }
      body.export-view {
        margin-left: 280px;
        padding: 20px 30px;
      }
      .section-note-box {
        border-top: 1px dashed var(--border-color);
        padding: 10px 15px;
        margin-top: 15px;
        background-color: #f8f9fa;
        min-height: 20px;
        font-size: 0.85em;
        color: #777;
        line-height: 1.5;
        font-style: italic;
        cursor: default;
      }
      .analysis-section > .section-note-box {
        margin-top: 25px;
        font-size: 0.9em;
        color: #555;
      }
      tfoot tr {
        background-color: #e0eafc !important;
        border-top: 2px solid var(--primary-color) !important;
        position: sticky !important;
        bottom: 0 !important;
      }
      tfoot td {
        font-weight: bold !important;
        color: var(--heading-color) !important;
        background-color: #e0eafc !important;
      }
      @media print {
        #export-sidebar,
        .page-controls,
        .filter-status,
        header {
          display: none !important;
        }
        body.export-view {
          margin-left: 0;
          padding: 0;
        }
        .chart-card,
        .analysis-section {
          box-shadow: none;
          border: 1px solid #ccc;
          page-break-inside: avoid;
        }
        .section-note-box {
          background-color: #fff;
          border-top: none;
          padding-top: 5px;
          margin-top: 5px;
          min-height: 0;
          font-style: normal;
          color: #555;
        }
        tfoot tr {
          background-color: #f0f0f0 !important;
          position: static !important;
        }
        tfoot td {
          background-color: #f0f0f0 !important;
        }
      }
      /* HẾT CSS CHO FILE EXPORT */
      header,
      .analysis-section {
        text-align: center;
        margin-bottom: 25px;
        padding: 25px 30px;
        background-color: var(--card-background);
        border-radius: 12px;
        box-shadow: 0 5px 15px var(--shadow-color);
        border: 1px solid var(--border-color);
      }
      h1 {
        color: var(--heading-color);
        margin: 0 0 10px 0;
        font-size: 2.2em;
        font-weight: 700;
      }
      h2 {
        color: var(--heading-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
        margin-top: 40px;
        text-align: left;
        font-size: 1.6em;
        font-weight: 600;
      }
      .file-uploader {
        display: flex;
        justify-content: center;
        gap: 15px;
        align-items: center;
        margin-top: 15px;
        flex-wrap: wrap;
      }
      .file-uploader input[type="file"] {
        padding: 12px 20px;
        border: 2px dashed var(--primary-color);
        border-radius: 8px;
        background-color: #f8f9fa;
        cursor: pointer;
        font-size: 1em;
      }
      .export-full-btn {
        padding: 12px 20px;
        font-size: 1em;
        background-color: var(--warning-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .export-full-btn:hover {
        background-color: #e09414;
      }
      #loadingMessage {
        text-align: center;
        font-size: 1.2em;
        color: var(--text-color);
        display: none;
        margin-top: 20px;
      }
      .kpi-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }
      .kpi-card {
        background-color: var(--card-background);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 5px 15px var(--shadow-color);
        border: 1px solid var(--border-color);
        text-align: left;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .kpi-icon {
        flex-shrink: 0;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(74, 144, 226, 0.1);
      }
      .kpi-icon svg {
        width: 24px;
        height: 24px;
        stroke: var(--primary-color);
      }
      .kpi-info .kpi-title {
        font-size: 0.9em;
        color: var(--text-color);
        margin: 0 0 5px 0;
      }
      .kpi-info .kpi-value {
        font-size: 1.8em;
        font-weight: 700;
        color: var(--heading-color);
        margin: 0;
      }
      .dashboard-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 25px;
        margin-top: 25px;
        margin-bottom: 40px;
      }
      .chart-card {
        background-color: var(--card-background);
        border-radius: 12px;
        box-shadow: 0 5px 15px var(--shadow-color);
        padding: 20px;
        box-sizing: border-box;
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
      }
      .chart-card h3,
      .analysis-section h3 {
        margin-top: 0;
        font-size: 1.2em;
        color: var(--heading-color);
        text-align: left;
        font-weight: 600;
        flex-shrink: 0;
      }
      .chart-canvas-wrapper {
        position: relative;
        flex-grow: 1;
        height: 400px;
      }
      .interactive-table-container {
        margin-top: 20px;
        text-align: left;
      }
      .table-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      /* === CSS BỘ LỌC NÂNG CẤP === */
      .filter-container {
        display: flex;
        gap: 15px;
        width: 100%;
        flex-wrap: wrap;
      }
      .filter-group {
        position: relative;
        flex-grow: 1;
        min-width: 200px;
      }
      .filter-group.search-group {
        max-width: 400px;
      }
      .filter-group .filter-label {
        font-size: 0.85em;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 5px;
        display: block;
      }
      .filter-search-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 1em;
      }
      .filter-dropdown-toggle {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #fff;
        cursor: pointer;
        text-align: left;
        font-size: 1em;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .filter-dropdown-toggle span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding-right: 5px;
      }
      .filter-dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        background-color: #fff;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 8px 8px;
        z-index: 100;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        padding: 10px;
        box-sizing: border-box;
      }
      .filter-dropdown-menu.show {
        display: block;
      }
      .filter-dropdown-search {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        border: 1px solid #eee;
        border-radius: 5px;
        margin-bottom: 10px;
      }
      .filter-dropdown-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .filter-dropdown-list li {
        padding: 5px 0;
      }
      .filter-dropdown-list label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 0.95em;
      }
      .filter-dropdown-list input[type="checkbox"] {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }
      /* === HẾT CSS BỘ LỌC === */
      .table-wrapper {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
      }
      th,
      td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        text-align: left;
      }
      thead th {
        background-color: var(--primary-color);
        color: white;
        position: sticky;
        top: 0;
        z-index: 1;
        font-weight: 600;
      }
      tbody tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      tbody tr:hover {
        background-color: #e9eff8;
      }
      .price-diff-pos {
        color: #198754;
        font-weight: bold;
      }
      .price-diff-neg {
        color: #dc3545;
        font-weight: bold;
      }
      .filter-status {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: var(--secondary-color);
        color: white;
        padding: 10px 20px;
        text-align: center;
        font-weight: bold;
        z-index: 1001;
        display: none;
        box-sizing: border-box;
      }
      .page-controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .control-btn {
        padding: 10px 15px;
        font-size: 1em;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #scrollToTopBtn {
        background-color: var(--primary-color);
        color: white;
      }
      #clearFilterBtn {
        background-color: var(--danger-color);
        color: white;
      }
      .control-btn:hover {
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Dashboard Đối Soát Dữ Liệu (Matching / Không Matching)</h1>
      <p>
        Tải file Excel (.xlsx) chứa cột
        <strong>Matching/Không matching</strong> để phân tích
      </p>
      <div class="file-uploader">
        <input type="file" id="excelFile" accept=".xlsx, .xls" />
        <button
          id="exportFullDashboardBtn"
          class="export-full-btn"
          style="display: none"
        >
          <i class="fas fa-download"></i> Export Full Dashboard
        </button>
      </div>
      <div id="loadingMessage">Đang xử lý dữ liệu và vẽ biểu đồ...</div>
    </header>
    <div id="filterStatus" class="filter-status"></div>
    <div class="page-controls">
      <button id="clearFilterBtn" class="control-btn" style="display: none">
        <i class="fas fa-eraser"></i>
      </button>
      <button id="scrollToTopBtn" class="control-btn">
        <i class="fas fa-arrow-up"></i>
      </button>
    </div>
    <main id="dashboardArea" style="display: none">
      <div id="kpi-section" class="kpi-container">
        <div class="kpi-card">
          <div class="kpi-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25A2.25 2.25 0 0 1 5.25 3h9.75a2.25 2.25 0 0 1 2.25 2.25Z"
              />
            </svg>
          </div>
          <div class="kpi-info">
            <p class="kpi-title">Tổng SL HQ (chiếc)</p>
            <h3 id="totalQuantity" class="kpi-value">0</h3>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
              />
            </svg>
          </div>
          <div class="kpi-info">
            <p class="kpi-title">Tổng Giá Trị HQ (VND)</p>
            <h3 id="totalValue" class="kpi-value">0</h3>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6.75h1.5m-1.5 3h1.5m-1.5 3h1.5M15 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5"
              />
            </svg>
          </div>
          <div class="kpi-info">
            <p class="kpi-title">Số Lượng Công Ty</p>
            <h3 id="uniqueCompanies" class="kpi-value">0</h3>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3.75 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5a1.875 1.875 0 0 1-1.875-1.875v-4.5ZM13.5 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0 1 13.5 9.375v-4.5Z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M13.5 14.625a1.875 1.875 0 0 1 1.875-1.875h4.5a1.875 1.875 0 0 1 1.875 1.875v4.5a1.875 1.875 0 0 1-1.875 1.875h-4.5a1.875 1.875 0 0 1-1.875-1.875v-4.5Z"
              />
            </svg>
          </div>
          <div class="kpi-info">
            <p class="kpi-title">Số SKU Matching</p>
            <h3 id="matchedSkus" class="kpi-value">0</h3>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"
              />
            </svg>
          </div>
          <div class="kpi-info">
            <p class="kpi-title">Số Dòng Không Matching</p>
            <h3 id="unmatchedEntries" class="kpi-value">0</h3>
          </div>
        </div>
      </div>
      <h2 id="overview-section">Tổng Quan Đối Soát</h2>
      <div class="dashboard-container" id="chartContainer"></div>
      <div id="matching-analysis-section" class="analysis-section">
        <h2>Sản phẩm Matching (Đã Khớp)</h2>
        <div class="interactive-table-container">
          <div class="table-controls">
            <div id="matchingFilterContainer" class="filter-container"></div>
          </div>
          <div class="table-wrapper">
            <table id="matchingTable">
              <thead>
                <tr>
                  <th>MÃ SKU</th>
                  <th>Tên hàng</th>
                  <th>SL NK</th>
                  <th>SL HQ</th>
                  <th>Giá trị HQ (VND)</th>
                  <th>Hãng</th>
                  <th>Nhóm hàng</th>
                  <th>Công ty nhập</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="unmatched-part-section" class="analysis-section">
        <h2>Sản phẩm Không Matching (Cần Xử Lý)</h2>
        <div class="interactive-table-container">
          <div class="table-controls">
            <div id="unmatchedFilterContainer" class="filter-container"></div>
          </div>
          <div class="table-wrapper">
            <table id="unmatchedTable">
              <thead>
                <tr>
                  <th>MÃ SKU</th>
                  <th>Tên hàng</th>
                  <th>SL NK</th>
                  <th>SL HQ</th>
                  <th>Chênh lệch SL</th>
                  <th>Giá trị HQ (VND)</th>
                  <th>Hãng</th>
                  <th>Công ty nhập</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
    <script id="main-processing-script">
      // === CẤU HÌNH CỘT THEO FILE MẪU ===
      const COLS = {
        SKU: "MÃ SKU",
        TEN_HANG: "Tên hàng",
        SL_NK: "Tổng Số Hàng NK (chiếc)",
        SL_HQ: "Tổng Số Hàng HQ (chiếc)",
        DG_NK: "Đơn giá NK",
        DG_HQ: "Đơn giá HQ",
        GT_NK: "Tổng Giá Trị NK (VND)",
        GT_HQ: "Tổng Giá Trị HQ (VND)",
        NHOM_HANG: "Nhóm hàng",
        HANG: "Hãng sản xuất",
        MATCH_STATUS: "Matching/Không matching",
        CONG_TY: "Công ty nhập",
        THI_TRUONG: "Thị trường nhập khẩu",
      };

      let allCharts = [];
      let fullData = [];
      let currentFilter = null;
      let matchingFilterInstance = null;
      let unmatchedFilterInstance = null;

      // === HÀM TIỆN ÍCH ===
      const cleanNumeric = function (val) {
        if (typeof val === "number") return val;
        if (!val || typeof val !== "string") return 0;
        let strVal = String(val)
          .replace(/\./g, "")
          .replace(",", ".");
        strVal = strVal.replace(/[^0-9.-]/g, "");
        return parseFloat(strVal) || 0;
      };

      const formatNumber = function (num) {
        return num.toLocaleString("vi-VN", { maximumFractionDigits: 0 });
      };
      const formatCurrencyVND = function (num) {
        if (num >= 1e9) return (num / 1e9).toFixed(2) + " Tỷ";
        if (num >= 1e6) return (num / 1e6).toFixed(2) + " Tr";
        return formatNumber(num);
      };

      // === BỘ LỌC NÂNG CẤP ===
      class ProFilter {
        constructor(containerId, data, config) {
          this.container = document.getElementById(containerId);
          if (!this.container)
            throw new Error("Filter container not found: " + containerId);
          this.data = data;
          this.config = config;
          this.state = {};
          this.container.innerHTML = "";
          this.init();
        }

        init() {
          this.config.forEach((filter) => {
            const group = document.createElement("div");
            group.className = "filter-group";

            const label = document.createElement("label");
            label.className = "filter-label";
            label.textContent = filter.label;
            group.appendChild(label);

            if (filter.type === "search") {
              group.classList.add("search-group");
              const input = document.createElement("input");
              input.type = "text";
              input.placeholder = `Tìm theo ${filter.label}...`;
              input.className = "filter-search-input";
              input.dataset.key = filter.key;
              input.addEventListener("input", (e) => this.onSearchChange(e));
              group.appendChild(input);
              this.state[filter.key] = "";
            } else {
              const values = [
                ...new Set(this.data.map((r) => r[filter.key] || "Khác")),
              ].sort();

              const toggle = document.createElement("button");
              toggle.className = "filter-dropdown-toggle";
              group.appendChild(toggle);

              const menu = document.createElement("div");
              menu.className = "filter-dropdown-menu";

              const search = document.createElement("input");
              search.type = "text";
              search.placeholder = "Tìm...";
              search.className = "filter-dropdown-search";
              search.addEventListener("input", (e) => this.onFilterSearch(e));
              menu.appendChild(search);

              const list = document.createElement("ul");
              list.className = "filter-dropdown-list";

              let defaultVal = null;
              if (filter.default) {
                const defaultLower = filter.default.toLowerCase();
                defaultVal = values.find(
                  (v) => v.toLowerCase().indexOf(defaultLower) !== -1
                );
              }

              if (defaultVal) {
                this.state[filter.key] = [defaultVal];
                toggle.innerHTML = `<span>${defaultVal}</span> <i class="fas fa-chevron-down"></i>`;
              } else {
                this.state[filter.key] = [];
                toggle.innerHTML = `<span>-- Tất cả ${filter.label} --</span> <i class="fas fa-chevron-down"></i>`;
              }

              values.forEach((val) => {
                const li = document.createElement("li");
                const safeVal = String(val).replace(/"/g, "&quot;");
                const isChecked = defaultVal === val ? "checked" : "";
                li.innerHTML = `
                                <label>
                                    <input type="checkbox" value="${safeVal}" data-key="${filter.key}" ${isChecked}>
                                    <span>${val}</span>
                                </label>
                            `;
                list.appendChild(li);
              });

              list.addEventListener("change", (e) =>
                this.onCheckboxChange(e, filter.key, toggle)
              );
              menu.appendChild(list);
              group.appendChild(menu);
              toggle.addEventListener("click", (e) => this.toggleDropdown(e));
            }
            this.container.appendChild(group);
          });

          document.addEventListener("click", (e) => {
            let targetEl = e.target;
            let isFilterClick = false;
            while (targetEl) {
              if (targetEl === this.container) {
                isFilterClick = true;
                break;
              }
              targetEl = targetEl.parentElement;
            }

            if (!isFilterClick) {
              this.container
                .querySelectorAll(".filter-dropdown-menu.show")
                .forEach((menu) => menu.classList.remove("show"));
            }
          });
        }

        onSearchChange(e) {
          const key = e.target.dataset.key;
          this.state[key] = e.target.value.toLowerCase();
          this.dispatchFilterChange();
        }

        toggleDropdown(e) {
          e.stopPropagation();
          const menu = e.currentTarget.nextElementSibling;
          this.container
            .querySelectorAll(".filter-dropdown-menu.show")
            .forEach((m) => {
              if (m !== menu) m.classList.remove("show");
            });
          if (menu) menu.classList.toggle("show");
        }

        onFilterSearch(e) {
          const term = e.target.value.toLowerCase();
          const list = e.target.nextElementSibling;
          list.querySelectorAll("li").forEach((li) => {
            const label = li.querySelector("span").textContent.toLowerCase();
            li.style.display = label.includes(term) ? "" : "none";
          });
        }

        onCheckboxChange(e, key, toggle) {
          const selected = Array.from(
            e.currentTarget.querySelectorAll("input[type=\"checkbox\"]:checked")
          ).map((cb) => cb.value);
          this.state[key] = selected;

          const span = toggle.querySelector("span");
          if (selected.length === 0) {
            span.textContent = `-- Tất cả ${
              this.config.find((f) => f.key === key).label
            } --`;
          } else if (selected.length === 1) {
            span.textContent = selected[0];
          } else {
            span.textContent = `${selected.length} đã chọn`;
          }

          this.dispatchFilterChange();
        }

        dispatchFilterChange() {
          const event = new CustomEvent("filterChange", {
            detail: this.state,
          });
          this.container.dispatchEvent(event);
        }

        getState() {
          return this.state;
        }

        destroy() {
          this.container.innerHTML = "";
        }
      }
      // === HẾT BỘ LỌC NÂNG CẤP ===

      // === VẼ BIỂU ĐỒ NGHIỆP VỤ ===
      function drawReconciliationCharts(data) {
        const container = document.getElementById("chartContainer");
        container.innerHTML = "";

        const matchingData = data.filter(function (r) {
          return r[COLS.MATCH_STATUS] === "Matching";
        });
        const unmatchedData = data.filter(function (r) {
          return r[COLS.MATCH_STATUS] !== "Matching";
        });

        const configs = [
          {
            title: "1. Tỷ lệ sản phẩm Matching vs Không Matching",
            type: "doughnut",
            data: {
              labels: ["Matching", "Không Matching"],
              datasets: [
                {
                  data: [matchingData.length, unmatchedData.length],
                  backgroundColor: ["#28a745", "#d0021b"],
                },
              ],
            },
          },
          {
            title: "2. Top 20 SKU có chênh lệch số lượng lớn nhất",
            type: "bar",
            data: (function () {
              const diff = unmatchedData
                .map(function (r) {
                  return {
                    sku: r[COLS.SKU],
                    diff: Math.abs(
                      cleanNumeric(r[COLS.SL_HQ]) - cleanNumeric(r[COLS.SL_NK])
                    ),
                  };
                })
                .sort(function (a, b) {
                  return b.diff - a.diff;
                })
                .slice(0, 20);
              return {
                labels: diff.map(function (d) {
                  return d.sku;
                }),
                datasets: [
                  {
                    label: "Chênh lệch SL",
                    data: diff.map(function (d) {
                      return d.diff;
                    }),
                    backgroundColor: "#f5a623",
                  },
                ],
              };
            })(),
            options: { indexAxis: "y" },
          },
          {
            title: "3. Top 20 SKU có chênh lệch giá trị lớn nhất (VND)",
            type: "bar",
            data: (function () {
              const diff = unmatchedData
                .map(function (r) {
                  return {
                    sku: r[COLS.SKU],
                    diff: Math.abs(
                      cleanNumeric(r[COLS.GT_HQ]) - cleanNumeric(r[COLS.GT_NK])
                    ),
                  };
                })
                .sort(function (a, b) {
                  return b.diff - a.diff;
                })
                .slice(0, 20);
              return {
                labels: diff.map(function (d) {
                  return d.sku;
                }),
                datasets: [
                  {
                    label: "Chênh lệch Giá trị",
                    data: diff.map(function (d) {
                      return d.diff;
                    }),
                    backgroundColor: "#d0021b",
                  },
                ],
              };
            })(),
            options: {
              indexAxis: "y",
              scales: {
                x: {
                  ticks: {
                    callback: function (v) {
                      return v >= 1e9
                        ? (v / 1e9).toFixed(1) + " Tỷ"
                        : v.toLocaleString("vi-VN");
                    },
                  },
                },
              },
            },
          },
          {
            title: "4. Tổng số lượng theo Nhóm hàng (Matching)",
            type: "bar",
            data: (function () {
              const groups = {};
              matchingData.forEach(function (r) {
                const g = r[COLS.NHOM_HANG] || "Khác";
                groups[g] = (groups[g] || 0) + cleanNumeric(r[COLS.SL_HQ]);
              });
              return {
                labels: Object.keys(groups),
                datasets: [
                  {
                    label: "Số lượng",
                    data: Object.values(groups),
                    backgroundColor: "#4a90e2",
                  },
                ],
              };
            })(),
          },
          {
            title: "5. Tổng giá trị theo Hãng sản xuất (Matching)",
            type: "bar",
            data: (function () {
              const brands = {};
              matchingData.forEach(function (r) {
                const b = r[COLS.HANG] || "Khác";
                brands[b] = (brands[b] || 0) + cleanNumeric(r[COLS.GT_HQ]);
              });
              const sortedBrands = Object.entries(brands).sort(function (a, b) {
                return a[1] - b[1];
              });
              return {
                labels: sortedBrands.map(function (d) {
                  return d[0];
                }),
                datasets: [
                  {
                    label: "Giá trị (VND)",
                    data: sortedBrands.map(function (d) {
                      return d[1];
                    }),
                    backgroundColor: "#50e3c2",
                  },
                ],
              };
            })(),
            options: {
              indexAxis: "y",
              scales: {
                x: {
                  ticks: {
                    callback: function (v) {
                      return v >= 1e9
                        ? (v / 1e9).toFixed(1) + " Tỷ"
                        : v.toLocaleString("vi-VN");
                    },
                  },
                },
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    afterBody: function (context) {
                      const brand = context[0].label;
                      // === NÂNG CẤP TOOLTIP 1 ===
                      const products = matchingData
                        .filter((r) => (r[COLS.HANG] || "Khác") === brand)
                        .map((r) => r[COLS.SKU] || "N/A") // Chỉ lấy SKU
                        .filter((v, i, a) => a.indexOf(v) === i); // Unique

                      const displayLimit = 5;
                      const displayedProducts = products
                        .slice(0, displayLimit)
                        .map((p) => "  - " + p);
                      if (products.length > displayLimit) {
                        displayedProducts.push(
                          "  ...và " +
                            (products.length - displayLimit) +
                            " SKU khác" // Cập nhật text
                        );
                      }
                      if (products.length > 0) {
                        return ["Mã SKU matching:", ...displayedProducts]; // Cập nhật title
                      }
                      return "Không có sản phẩm nào.";
                      // === KẾT THÚC NÂNG CẤP ===
                    },
                  },
                },
              },
            },
          },
          {
            title: "5b. Tổng số lượng theo Hãng sản xuất (Matching)",
            type: "bar",
            data: (function () {
              const brands = {};
              matchingData.forEach(function (r) {
                const b = r[COLS.HANG] || "Khác";
                brands[b] = (brands[b] || 0) + cleanNumeric(r[COLS.SL_HQ]);
              });
              const sortedBrands = Object.entries(brands).sort(function (a, b) {
                return a[1] - b[1];
              });
              return {
                labels: sortedBrands.map(function (d) {
                  return d[0];
                }),
                datasets: [
                  {
                    label: "Số lượng (chiếc)",
                    data: sortedBrands.map(function (d) {
                      return d[1];
                    }),
                    backgroundColor: "#4a90e2",
                  },
                ],
              };
            })(),
            options: {
              indexAxis: "y",
              plugins: {
                tooltip: {
                  callbacks: {
                    afterBody: function (context) {
                      const brand = context[0].label;
                      // === NÂNG CẤP TOOLTIP 2 ===
                      const products = matchingData
                        .filter((r) => (r[COLS.HANG] || "Khác") === brand)
                        .map((r) => r[COLS.SKU] || "N/A") // Chỉ lấy SKU
                        .filter((v, i, a) => a.indexOf(v) === i); // Unique

                      const displayLimit = 5;
                      const displayedProducts = products
                        .slice(0, displayLimit)
                        .map((p) => "  - " + p);
                      if (products.length > displayLimit) {
                        displayedProducts.push(
                          "  ...và " +
                            (products.length - displayLimit) +
                            " SKU khác" // Cập nhật text
                        );
                      }
                      if (products.length > 0) {
                        return ["Mã SKU matching:", ...displayedProducts]; // Cập nhật title
                      }
                      return "Không có sản phẩm nào.";
                      // === KẾT THÚC NÂNG CẤP ===
                    },
                  },
                },
              },
            },
          },
          {
            title: "6. Số lượng sản phẩm Không Matching theo Hãng sản xuất",
            type: "bar",
            data: (function () {
              const brands = {};
              unmatchedData.forEach(function (r) {
                const b = r[COLS.HANG] || "Khác";
                brands[b] = (brands[b] || 0) + 1;
              });
              const sortedBrands = Object.entries(brands).sort(function (a, b) {
                return a[1] - b[1];
              });
              return {
                labels: sortedBrands.map(function (d) {
                  return d[0];
                }),
                datasets: [
                  {
                    label: "Số dòng",
                    data: sortedBrands.map(function (d) {
                      return d[1];
                    }),
                    backgroundColor: "#bd10e0",
                  },
                ],
              };
            })(),
            options: {
              indexAxis: "y",
              plugins: {
                tooltip: {
                  callbacks: {
                    afterBody: function (context) {
                      const brand = context[0].label;
                      // === NÂNG CẤP TOOLTIP 3 ===
                      const products = unmatchedData
                        .filter((r) => (r[COLS.HANG] || "Khác") === brand)
                        .map((r) => r[COLS.SKU] || "N/A") // Chỉ lấy SKU
                        .filter((v, i, a) => a.indexOf(v) === i); // Unique

                      const displayLimit = 5;
                      const displayedProducts = products
                        .slice(0, displayLimit)
                        .map((p) => "  - " + p);
                      if (products.length > displayLimit) {
                        displayedProducts.push(
                          "  ...và " +
                            (products.length - displayLimit) +
                            " SKU khác" // Cập nhật text
                        );
                      }
                      if (products.length > 0) {
                        return ["Mã SKU không matching:", ...displayedProducts]; // Cập nhật title
                      }
                      return "Không có sản phẩm nào.";
                      // === KẾT THÚC NÂNG CẤP ===
                    },
                  },
                },
              },
            },
          },
          /* Đã xóa biểu đồ 6b */
          {
            title:
              "7. Chênh lệch đơn giá trung bình theo Thị trường nhập khẩu",
            type: "bar",
            data: (function () {
              const markets = {};
              unmatchedData.forEach(function (r) {
                const m = r[COLS.THI_TRUONG] || "Khác";
                const dg_hq = cleanNumeric(r[COLS.DG_HQ]);
                const dg_nk = cleanNumeric(r[COLS.DG_NK]);
                if (dg_hq > 0 && dg_nk > 0) {
                  if (!markets[m]) markets[m] = [];
                  markets[m].push(Math.abs(dg_hq - dg_nk));
                }
              });
              const avg = {};
              for (const m in markets)
                avg[m] =
                  markets[m].reduce(function (a, b) {
                    return a + b;
                  }, 0) / markets[m].length;
              return {
                labels: Object.keys(avg),
                datasets: [
                  {
                    label: "Chênh lệch Đơn giá TB (VND)",
                    data: Object.values(avg),
                    backgroundColor: "#9013fe",
                  },
                ],
              };
            })(),
            options: {
              scales: {
                y: {
                  ticks: {
                    callback: function (v) {
                      return v.toLocaleString("vi-VN");
                    },
                  },
                },
              },
            },
          },
          {
            title: "8. Top 10 SKU Không Matching có giá trị HQ cao nhất",
            type: "bar",
            data: (function () {
              const top = unmatchedData
                .map(function (r) {
                  return { sku: r[COLS.SKU], gt: cleanNumeric(r[COLS.GT_HQ]) };
                })
                .sort(function (a, b) {
                  return b.gt - a.gt;
                })
                .slice(0, 10)
                .filter(function (d) {
                  return d.gt > 0;
                });
              return {
                labels: top.map(function (d) {
                  return d.sku;
                }),
                datasets: [
                  {
                    label: "Giá trị HQ (VND)",
                    data: top.map(function (d) {
                      return d.gt;
                    }),
                    backgroundColor: "#f5a623",
                  },
                ],
              };
            })(),
            options: {
              indexAxis: "y",
              scales: {
                x: {
                  ticks: {
                    callback: function (v) {
                      return v >= 1e9
                        ? (v / 1e9).toFixed(1) + " Tỷ"
                        : v.toLocaleString("vi-VN");
                    },
                  },
                },
              },
            },
          },
          {
            title: "10. So sánh tổng số lượng NK vs HQ theo Nhóm hàng",
            type: "bar",
            data: (function () {
              const nk = {},
                hq = {};
              data.forEach(function (r) {
                const g = r[COLS.NHOM_HANG] || "Khác";
                nk[g] = (nk[g] || 0) + cleanNumeric(r[COLS.SL_NK]);
                hq[g] = (hq[g] || 0) + cleanNumeric(r[COLS.SL_HQ]);
              });
              const groups = [...new Set([...Object.keys(nk), ...Object.keys(hq)])];
              return {
                labels: groups,
                datasets: [
                  {
                    label: "SL NK",
                    data: groups.map(function (g) {
                      return nk[g] || 0;
                    }),
                    backgroundColor: "rgba(245,166,35,0.7)",
                  },
                  {
                    label: "SL HQ",
                    data: groups.map(function (g) {
                      return hq[g] || 0;
                    }),
                    backgroundColor: "rgba(74,144,226,0.7)",
                  },
                ],
              };
            })(),
          },
        ];

        configs.forEach(function (config) {
          if (!config.data.labels || config.data.labels.length === 0) return;
          const card = document.createElement("div");
          card.className = "chart-card";
          card.innerHTML =
            "<h3>" +
            config.title +
            "</h3><div class=\"chart-canvas-wrapper\"><canvas></canvas></div>";
          const canvas = card.querySelector("canvas");
          if (config.options && config.options.indexAxis === "y") {
            const labelCount = config.data.labels.length;
            const newHeight = Math.max(400, labelCount * 20);
            canvas.parentElement.style.height = newHeight + "px";
          }
          const chart = new Chart(canvas, {
            type: config.type,
            data: config.data,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: config.type !== "doughnut" } },
              ...config.options,
            },
          });
          allCharts.push(chart);
          container.appendChild(card);
        });
      }

      // === CẬP NHẬT KPIs ===
      function updateKPIs(data) {
        const matchingData = data.filter(function (r) {
          return r[COLS.MATCH_STATUS] === "Matching";
        });
        const unmatchedData = data.filter(function (r) {
          return r[COLS.MATCH_STATUS] !== "Matching";
        });

        const totalSL = data.reduce(function (sum, r) {
          return sum + cleanNumeric(r[COLS.SL_HQ]);
        }, 0);
        const totalGT = data.reduce(function (sum, r) {
          return sum + cleanNumeric(r[COLS.GT_HQ]);
        }, 0);
        const uniqueCompanies = new Set(
          data
            .map(function (r) {
              return r[COLS.CONG_TY];
            })
            .filter(Boolean)
        ).size;
        const matchedSKUs = new Set(
          matchingData.map(function (r) {
            return r[COLS.SKU];
          })
        ).size;

        document.getElementById("totalQuantity").textContent = formatNumber(totalSL);
        document.getElementById("totalValue").textContent =
          formatCurrencyVND(totalGT);
        document.getElementById("uniqueCompanies").textContent =
          formatNumber(uniqueCompanies);
        document.getElementById("matchedSkus").textContent =
          formatNumber(matchedSKUs);
        document.getElementById("unmatchedEntries").textContent = formatNumber(
          unmatchedData.length
        );
      }

      // === CẬP NHẬT BẢNG (ĐÃ SỬA) ===
      function populateTables(data) {
        const matchingData = data.filter(function (r) {
          return r[COLS.MATCH_STATUS] === "Matching";
        });
        const unmatchedData = data.filter(function (r) {
          return r[COLS.MATCH_STATUS] !== "Matching";
        });

        const matchingTbody = document.querySelector("#matchingTable tbody");
        const unmatchedTbody = document.querySelector("#unmatchedTable tbody");

        // --- 1. Xử lý Bảng Matching ---
        if (matchingFilterInstance) matchingFilterInstance.destroy();
        matchingFilterInstance = new ProFilter(
          "matchingFilterContainer",
          matchingData,
          [
            { key: COLS.SKU, label: "SKU / Tên hàng", type: "search" },
            { key: COLS.HANG, label: "Hãng sản xuất", type: "select" },
            { key: COLS.CONG_TY, label: "Công ty nhập", type: "select" },
          ]
        );

        // Hàm render cho Bảng Matching
        function renderMatching() {
          const filters = matchingFilterInstance.getState();
          const searchTerm = filters[COLS.SKU] || "";
          const selectedHangs = filters[COLS.HANG] || [];
          const selectedCongTys = filters[COLS.CONG_TY] || [];

          const filteredData = matchingData.filter((r) => {
            const hang = r[COLS.HANG] || "Khác";
            const congTy = r[COLS.CONG_TY] || "Khác";
            const sku = (r[COLS.SKU] || "").toLowerCase();
            const tenHang = (r[COLS.TEN_HANG] || "").toLowerCase();

            const matchesHang =
              selectedHangs.length === 0 || selectedHangs.includes(hang);
            const matchesCongTy =
              selectedCongTys.length === 0 || selectedCongTys.includes(congTy);
            const matchesSearch =
              !searchTerm ||
              sku.includes(searchTerm) ||
              tenHang.includes(searchTerm);

            return matchesHang && matchesCongTy && matchesSearch;
          });

          matchingTbody.innerHTML = "";
          filteredData.forEach(function (r) {
            const tr = document.createElement("tr");
            tr.innerHTML =
              "<td>" +
              (r[COLS.SKU] || "") +
              "</td>" +
              "<td>" +
              (r[COLS.TEN_HANG] || "") +
              "</td>" +
              "<td>" +
              formatNumber(cleanNumeric(r[COLS.SL_NK])) +
              "</td>" +
              "<td>" +
              formatNumber(cleanNumeric(r[COLS.SL_HQ])) +
              "</td>" +
              "<td>" +
              formatNumber(cleanNumeric(r[COLS.GT_HQ])) +
              "</td>" +
              "<td>" +
              (r[COLS.HANG] || "") +
              "</td>" +
              "<td>" +
              (r[COLS.NHOM_HANG] || "") +
              "</td>" +
              "<td>" +
              (r[COLS.CONG_TY] || "") +
              "</td>";
            matchingTbody.appendChild(tr);
          });
        }

        document
          .getElementById("matchingFilterContainer")
          .addEventListener("filterChange", renderMatching);
        renderMatching();

        // --- 2. Xử lý Bảng Không Matching ---
        if (unmatchedFilterInstance) unmatchedFilterInstance.destroy();
        unmatchedFilterInstance = new ProFilter(
          "unmatchedFilterContainer",
          unmatchedData,
          [
            { key: COLS.SKU, label: "SKU / Tên hàng", type: "search" },
            { key: COLS.HANG, label: "Hãng sản xuất", type: "select" },
            {
              key: COLS.CONG_TY,
              label: "Công ty nhập",
              type: "select",
              default: "Nguyên Kim",
            },
          ]
        );

        // Hàm render cho Bảng Không Matching
        function renderUnmatched() {
          const filters = unmatchedFilterInstance.getState();
          const searchTerm = filters[COLS.SKU] || "";
          const selectedHangs = filters[COLS.HANG] || [];
          const selectedCongTys = filters[COLS.CONG_TY] || [];

          const filteredData = unmatchedData.filter((r) => {
            const hang = (r[COLS.HANG] || "Khác").toString().trim() || "Khác";
            const congTy = r[COLS.CONG_TY] || "Khác";
            const sku = (r[COLS.SKU] || "").toLowerCase();
            const tenHang = (r[COLS.TEN_HANG] || "").toLowerCase();

            const matchesCongTy =
              selectedCongTys.length === 0 || selectedCongTys.includes(congTy);
            const matchesHang =
              selectedHangs.length === 0 || selectedHangs.includes(hang);
            const matchesSearch =
              !searchTerm ||
              sku.includes(searchTerm) ||
              tenHang.includes(searchTerm);

            return matchesCongTy && matchesHang && matchesSearch;
          });

          unmatchedTbody.innerHTML = "";
          filteredData.forEach(function (r) {
            const sl_nk = cleanNumeric(r[COLS.SL_NK]);
            const sl_hq = cleanNumeric(r[COLS.SL_HQ]);
            const tr = document.createElement("tr");
            tr.innerHTML =
              "<td>" +
              (r[COLS.SKU] || "") +
              "</td>" +
              "<td>" +
              (r[COLS.TEN_HANG] || "") +
              "</td>" +
              "<td>" +
              formatNumber(sl_nk) +
              "</td>" +
              "<td>" +
              formatNumber(sl_hq) +
              "</td>" +
              "<td>" +
              formatNumber(Math.abs(sl_hq - sl_nk)) +
              "</td>" +
              "<td>" +
              formatNumber(cleanNumeric(r[COLS.GT_HQ])) +
              "</td>" +
              "<td>" +
              (r[COLS.HANG] || "") +
              "</td>" +
              "<td>" +
              (r[COLS.CONG_TY] || "") +
              "</td>";
            unmatchedTbody.appendChild(tr);
          });
        }

        document
          .getElementById("unmatchedFilterContainer")
          .addEventListener("filterChange", renderUnmatched);
        renderUnmatched();
      }

      // === CẬP NHẬT TOÀN BỘ GIAO DIỆN ===
      function updateAllVisuals(data) {
        allCharts.forEach(function (c) {
          if (c) c.destroy();
        });
        allCharts = [];
        drawReconciliationCharts(data);
        updateKPIs(data);
        populateTables(data);
      }

      // === HÀM EXPORT (ĐÃ SỬA LỖI) ===
      async function exportFullInteractiveDashboard() {
  const loadingMsg = document.getElementById("loadingMessage");
  loadingMsg.textContent = "Đang xuất dashboard...";
  loadingMsg.style.display = "block";

  // Clone toàn bộ DOM
  const doc = document.documentElement.cloneNode(true);
  const head = doc.querySelector("head");
  const body = doc.querySelector("body");
  body.classList.add("export-view");

  // Thêm sidebar mục lục
  const sidebar = document.createElement("nav");
  sidebar.id = "export-sidebar";
  sidebar.innerHTML = '<h3><i class="fas fa-sitemap"></i> Mục Lục Báo Cáo</h3><ul id="export-catalog-list"></ul>';
  body.prepend(sidebar);

  // Nhúng CSS cho export
  const exportStyle = document.createElement("style");
  exportStyle.textContent = `
    #export-sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100vh; background: var(--card-background); border-right: 1px solid var(--border-color); box-shadow: 4px 0 10px rgba(0,0,0,0.05); overflow-y: auto; z-index: 1010; padding: 20px; box-sizing: border-box; }
    #export-sidebar h3 { margin-top: 0; color: var(--heading-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; font-size: 1.2em; }
    #export-catalog-list { list-style: none; padding: 0; margin: 20px 0 0 0; }
    #export-catalog-list li a { text-decoration: none; color: var(--primary-color); font-size: 0.9em; padding: 8px 10px; display: block; border-radius: 5px; margin-bottom: 5px; transition: all 0.2s; }
    #export-catalog-list li a:hover { background-color: var(--background-color); color: var(--heading-color); }
    #export-catalog-list li a.section-title { font-weight: 700; color: var(--heading-color); font-size: 1em; padding-left: 0; margin-top: 15px; }
    #export-catalog-list li a.chart-title { padding-left: 20px; font-weight: 500; }
    body.export-view { margin-left: 280px; padding: 20px 30px; }
    .section-note-box { border-top: 1px dashed var(--border-color); padding: 10px 15px; margin-top: 15px; background-color: #f8f9fa; min-height: 20px; font-size: 0.85em; color: #777; line-height: 1.5; font-style: italic; cursor: default; }
    .analysis-section > .section-note-box { margin-top: 25px; font-size: 0.9em; color: #555; }
    @media print {
      #export-sidebar, .page-controls, .filter-status, header { display: none !important; }
      body.export-view { margin-left: 0; padding: 0; }
      .chart-card, .analysis-section { box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; }
      .section-note-box { background-color: #fff; border-top: none; padding-top: 5px; margin-top: 5px; min-height: 0; font-style: normal; color: #555; }
    }
  `;
  head.appendChild(exportStyle);

  // Thêm ghi chú
  doc.querySelectorAll(".chart-card").forEach((card, idx) => {
    const noteBox = document.createElement("div");
    noteBox.className = "section-note-box";
    noteBox.textContent = "[Ghi chú cho biểu đồ này]";
    card.appendChild(noteBox);
  });
  doc.querySelectorAll(".analysis-section").forEach((section) => {
    const noteBox = document.createElement("div");
    noteBox.className = "section-note-box";
    noteBox.textContent = "[Ghi chú cho bảng phân tích này]";
    section.appendChild(noteBox);
  });

  // Dọn sạch phần upload & nút export
  const uploader = body.querySelector(".file-uploader");
  if (uploader) uploader.remove();
  body.querySelectorAll(".export-full-btn").forEach(btn => btn.remove());
  const loadingEl = body.querySelector("#loadingMessage");
  if (loadingEl) loadingEl.remove();

  // XÓA script gốc để tránh xung đột
  const mainScript = body.querySelector("#main-processing-script");
  if (mainScript) mainScript.remove();

  // === NHÚNG CHART.JS TỪ CDN ===
  const chartJsScript = document.createElement("script");
  chartJsScript.src = "https://cdn.jsdelivr.net/npm/chart.js";
  chartJsScript.defer = true;
  head.appendChild(chartJsScript);

  // === TẠO SCRIPT KHỞI TẠO MỚI (AN TOÀN VỚI DOM) ===
  const logicScript = document.createElement("script");
  logicScript.textContent = `
    // === DỮ LIỆU ĐÃ NHÚNG ===
    const fullData = ${JSON.stringify(fullData)};
    const COLS = ${JSON.stringify(COLS)};

    // === HÀM TIỆN ÍCH ===
    const cleanNumeric = ${cleanNumeric.toString()};
    const formatNumber = ${formatNumber.toString()};
    const formatCurrencyVND = ${formatCurrencyVND.toString()};

    let allCharts = [];
    let matchingFilterInstance = null;
    let unmatchedFilterInstance = null;

    // === SAO CHÉP CÁC HÀM CẦN THIẾT ===
    ${ProFilter.toString()}
    ${drawReconciliationCharts.toString()}
    ${updateKPIs.toString()}
    ${populateTables.toString()}
    ${updateAllVisuals.toString()}

    // === HÀM TẠO MỤC LỤC (AN TOÀN) ===
    function generateExportCatalog() {
      const list = document.getElementById('export-catalog-list');
      if (!list) return;

      const items = [];

      const kpi = document.getElementById('kpi-section');
      if (kpi) {
        kpi.id = 'anchor-kpi';
        items.push({ text: 'Tổng Quan KPIs', id: 'anchor-kpi', type: 'section' });
      }

      const overview = document.getElementById('overview-section');
      if (overview) {
        items.push({ text: overview.innerText, id: 'overview-section', type: 'section' });
      }

      document.querySelectorAll('.chart-card').forEach((card, i) => {
        const title = card.querySelector('h3')?.innerText || 'Biểu đồ ' + (i + 1);
        const id = 'chart-' + i;
        card.id = id;
        items.push({ text: title, id, type: 'chart' });
      });

      document.querySelectorAll('.analysis-section').forEach((sec, i) => {
        const title = sec.querySelector('h2')?.innerText || 'Bảng ' + (i + 1);
        const id = 'section-' + i;
        sec.id = id;
        items.push({ text: title, id, type: 'section' });
      });

      list.innerHTML = items.map(item => 
        \`<li><a href="#\${item.id}" class="\${item.type}-title">\${item.text}</a></li>\`
      ).join('');
    }

    // === KHỞI TẠO SAU KHI DOM SẴN SÀNG VÀ CHART.JS TẢI XONG ===
    function initExportedDashboard() {
      try {
        if (typeof Chart === 'undefined') {
          setTimeout(initExportedDashboard, 100); // Thử lại sau 100ms
          return;
        }
        updateAllVisuals(fullData);
        generateExportCatalog();
      } catch (err) {
        console.error("❌ Lỗi khởi tạo dashboard xuất:", err);
      }
    }

    // Đảm bảo DOM đã sẵn sàng
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initExportedDashboard);
    } else {
      initExportedDashboard();
    }
  `;

  body.appendChild(logicScript);

  // Xuất file
  const htmlStr = "<!DOCTYPE html>" + doc.outerHTML;
  const blob = new Blob([htmlStr], { type: "text/html;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Dashboard_Matching_" + new Date().toISOString().slice(0, 10) + ".html";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  loadingMsg.style.display = "none";
}
      // === GẮN SỰ KIỆN ===
      document
        .getElementById("excelFile")
        ?.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const loading = document.getElementById("loadingMessage");
          loading.style.display = "block";
          const reader = new FileReader();
          reader.onload = function (ev) {
            try {
              const data = new Uint8Array(ev.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              const sheet = workbook.Sheets[workbook.SheetNames[0]];
              fullData = XLSX.utils.sheet_to_json(sheet);
              document.getElementById("dashboardArea").style.display = "block";
              document.getElementById("exportFullDashboardBtn").style.display =
                "flex";
              updateAllVisuals(fullData);
              loading.style.display = "none";
            } catch (err) {
              loading.textContent = "Lỗi xử lý file Excel.";
              console.error(err);
            }
          };
          reader.readAsArrayBuffer(file);
        });

      document
        .getElementById("exportFullDashboardBtn")
        ?.addEventListener("click", exportFullInteractiveDashboard);
      document
        .getElementById("scrollToTopBtn")
        ?.addEventListener("click", function () {
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
    </script>
  </body>
</html>
